---
title: 'ESM242 MiniGP: Fisheries -- Model Component'
author: "Emma Tao, Ryan Anderson, Jackson Hayes"
date: "2024-11-17"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Setting Up

```{r}
# Clear Env
rm(list = ls())

# Load Libraries
library(tidyverse)
library(nloptr)
library(knitr)
library(here)

# Set seed for reproducibility
set.seed(1234)
```


## Using Modules

```{r}
# run the module to get the funcitons
source(here("scripts", "fishery_model.R"))
```

## Optimization

```{r}

# Options
local_opts<-list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-15)
options=list("algorithm"="NLOPT_LN_AUGLAG",xtol_rel=1e-15,maxeval=32000,"local_opts"=local_opts)

# Run optimization with best estimates of parameters
SIMULATION_LENGTH <- 24
INITIAL_STOCK <- 1000
CARRYING_CAPACITY <- 2000
GROWTH_RATE <- 0.1
EFFORT_CAP <- 15
HARVEST_CONSTANT <- 0.05
MIGRATION_CONSTANT <- 0
UTIL_SCALING_CONSTANT <- 1
RHO <- 0.95

# Get the optiziation.R script in here
source(here("scripts", "optimization.R"))

# run the optimization helper func
result <- optimize_fishery_model(x0 = 1, EFFORT_CAP, INITIAL_STOCK, CARRYING_CAPACITY, GROWTH_RATE, HARVEST_CONSTANT, MIGRATION_CONSTANT, SIMULATION_LENGTH, RHO, UTIL_SCALING_CONSTANT)


```

## Inspecting Results

Let's see what's going on with the optimal values from the model run. Is it what we expect

```{r}
# Run the model with opimal values
optimal_run <- result$optimal_run

# Pull in the model_viz.R script
source(here("scripts", "model_viz.R"))

# Use the function to visualize the model run
plots <- vizualize_fishery_model_run(optimal_run)

# show the plots
plots$stock_plot
plots$harvest_plot
plots$effort_plot





```


## Business as Usual

Now let's re-try this process but use the business as usual constraint
```{r}
BAU_result <- nloptr(x0 = c(rep(1, SIMULATION_LENGTH), rep(1, SIMULATION_LENGTH)), eval_f = objective_function, lb = c(rep(0, SIMULATION_LENGTH), rep(0, SIMULATION_LENGTH)), ub = c(rep(EFFORT_CAP, SIMULATION_LENGTH), rep(EFFORT_CAP, SIMULATION_LENGTH)),
                 eval_g_ineq = constraint_function_BAU, opts = options, 
                 max_effort = EFFORT_CAP, initial_stock = INITIAL_STOCK, 
                 carrying_capacity = CARRYING_CAPACITY, r = GROWTH_RATE, 
                 q = HARVEST_CONSTANT, z = MIGRATION_CONSTANT, 
                 num_periods = SIMULATION_LENGTH, rho=RHO, util_scaling_constant = UTIL_SCALING_CONSTANT)

# Extract the optimal values
optimal_values_BAU <- BAU_result$solution

# Run the model with opimal values
optimal_run_BAU <- run_model(optimal_values_BAU[1:SIMULATION_LENGTH], optimal_values_BAU[(SIMULATION_LENGTH+1):(2*SIMULATION_LENGTH)], EFFORT_CAP, INITIAL_STOCK, CARRYING_CAPACITY, GROWTH_RATE, HARVEST_CONSTANT, MIGRATION_CONSTANT, SIMULATION_LENGTH, RHO, UTIL_SCALING_CONSTANT)

# Use the function to visualize the model run
plots_BAU <- vizualize_fishery_model_run(optimal_run_BAU)

# show the plots
plots_BAU$stock_plot
plots_BAU$harvest_plot
plots_BAU$effort_plot


```

